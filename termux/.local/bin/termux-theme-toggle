#!/usr/bin/env bash
# termux-theme-toggle - Switch Termux color theme between light and dark
# Usage: termux-theme-toggle [light|dark]
#   No args: toggle between light and dark
#   light:   switch to light theme
#   dark:    switch to dark theme
set -euo pipefail

TERMUX_DIR="$HOME/.termux"
COLORS_FILE="$TERMUX_DIR/colors.properties"
LIGHT_THEME="$TERMUX_DIR/colors.properties.light"
DARK_THEME="$TERMUX_DIR/colors.properties.dark"
THEME_STATE="$TERMUX_DIR/.current-theme"

log_info() { echo "ℹ️  $*"; }
log_ok() { echo "✅ $*"; }
log_warn() { echo "⚠️  $*"; }

get_current_theme() {
  if [[ -f "$THEME_STATE" ]]; then
    cat "$THEME_STATE"
  else
    echo "unknown"
  fi
}

set_theme() {
  local theme="$1"
  local source_file

  case "$theme" in
    light) source_file="$LIGHT_THEME" ;;
    dark)  source_file="$DARK_THEME" ;;
    *)
      log_warn "Unknown theme: $theme (use 'light' or 'dark')"
      exit 1
      ;;
  esac

  if [[ ! -f "$source_file" ]]; then
    log_warn "Theme file not found: $source_file"
    exit 1
  fi

  cp "$source_file" "$COLORS_FILE"
  echo "$theme" > "$THEME_STATE"

  if command -v termux-reload-settings &>/dev/null; then
    termux-reload-settings
  fi

  log_ok "Theme set to: $theme"
}

main() {
  if [[ ! -d "$TERMUX_DIR" ]]; then
    log_warn "Termux directory not found: $TERMUX_DIR"
    exit 1
  fi

  if [[ ! -f "$LIGHT_THEME" ]] || [[ ! -f "$DARK_THEME" ]]; then
    log_warn "Theme files not found. Expected:"
    log_warn "  $LIGHT_THEME"
    log_warn "  $DARK_THEME"
    exit 1
  fi

  local requested_theme="${1:-}"

  if [[ -n "$requested_theme" ]]; then
    set_theme "$requested_theme"
  else
    local current
    current="$(get_current_theme)"

    case "$current" in
      light) set_theme "dark" ;;
      dark)  set_theme "light" ;;
      *)
        log_info "Current theme unknown, defaulting to dark"
        set_theme "dark"
        ;;
    esac
  fi
}

main "$@"
